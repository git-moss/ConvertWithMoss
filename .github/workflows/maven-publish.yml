name: Build and publish jpackage result to GitHub

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:

  createmanual:
    runs-on: ubuntu-latest
    steps:
      - name: Configure
        uses: actions/checkout@v4
        
      - name: Create output folder
        run: mkdir output
      
      - name: Convert MD files to PDF
        uses: docker://pandoc/latex:2.9
        with:
          args: --standalone --toc -V geometry:margin=2.5cm --number-sections --output=output/ConvertWithMoss-Manual.pdf documentation/README.md documentation/README-FORMATS.md documentation/CHANGELOG.md
      
      - name: Publish result
        uses: actions/upload-artifact@v4
        with:
          name: ConvertWithMoss-Installers-Manual
          path: output/ConvertWithMoss-Manual.pdf

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: convertwithmoss*.deb
            build_name: linux
          - os: windows-latest
            artifact_name: ConvertWithMoss*.msi
            build_name: win-x64
          - os: windows-11-arm
            artifact_name: ConvertWithMoss*.msi
            build_name: win-arm
          - os: macos-14
            artifact_name: ConvertWithMoss*.dmg
            build_name: mac-arm
          - os: macos-13
            artifact_name: ConvertWithMoss*.dmg
            build_name: mac-x64
    
    name: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # Automatically choose ARM64 JDK for ARM runners
      - name: Set up JDK 25 (Zulu)
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 25
          architecture: ${{ contains(matrix.os, 'arm') && 'aarch64' || 'x64' }}
          check-latest: true

      - name: Verify Java
        run: java --version

      - name: Build and jpackage with Maven
        run: mvn -B package jpackage::jpackage@${{ matrix.build_name }} --file pom.xml

      - name: Publish jpackage result
        uses: actions/upload-artifact@v4
        with:
          name: ConvertWithMoss-Installers-${{ matrix.os }}
          path: target/release/${{ matrix.artifact_name }}

  merge:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Merge Artifacts
        uses: actions/upload-artifact/merge@v4
        with:
          name: ConvertWithMoss-Installers
          pattern: ConvertWithMoss-Installers-*
          separate-directories: true
